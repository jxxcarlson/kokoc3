<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>Reader</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/custom-elements/1.1.1/custom-elements.min.js"></script>
		
		<script type="text/x-mathjax-config">
			MathJax.Hub.Config(
				{ tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
				processEscapes: true,
				TeX: { equationNumbers: {autoNumber: "AMS"}}
				}
	        );
		</script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/asciidoctor.js/1.5.5-5/asciidoctor.js">
        </script>
		
		<script src="/Main.js" charset="utf-8"></script>
		<style>
			 p, h2 {
				padding: 5px;
				margin: 0;
				line-height: 1.4;
				}
				asciidoc-text {
				white-space: normal; 
			}
		
		</style>
	
	</head>

	<body>
		<div id="main"></div>


	

 	<script>

		var global = document.getElementById('main');
		var app = Elm.Main.init({node: global, flags:  {
					width:  window.innerWidth,
					height: window.innerHeight,
					location: location.href
				}
		});	
		
		// Inform app of browser navigation (the BACK and FORWARD buttons)
		document.addEventListener('popstate', function () {
			app.ports.onUrlChange.send(location.href);
		});

		// Change the URL upon request, inform app of the change.
		app.ports.pushUrl.subscribe(function(url) {
			history.pushState({}, '', url);
			app.ports.onUrlChange.send(location.href);
		});
				
		var typesetTimeout = null
		var typesetQueue = []
		function enqueueTypeset(el) {
			typesetQueue.push(el)
			clearTimeout(typesetTimeout)
			typesetTimeout = setTimeout(function () {
				var toTypeset = typesetQueue
				MathJax.Hub.Queue(["resetEquationNumbers", MathJax.InputJax.TeX]);
				MathJax.Hub.Queue(['Typeset', MathJax.Hub, typesetQueue], function (arg) {
					toTypeset.forEach(function (el) { el.style.opacity = 1 })
				})
				typesetQueue = []
			}, 1)
		}
		
		var updateQueue = []
		var updateTimeout = null
		function enqueueUpdate(el) {
			updateQueue.push(el)
			clearTimeout(updateTimeout)
			updateTimeout = setTimeout(function () {
				MathJax.Hub.Queue(['Update', MathJax.Hub, updateQueue])
				updateQueue = []
			}, 0)
		}
		
		customElements.define('math-text', class extends HTMLElement {
		  constructor() {
			super()
			this._content = this.content
		  }
		  
			get content() {
				return this._content
			}
		
			set content(value) {
				if (this._content === value) return
				this._content = value
				var jaxScript = this.querySelector('script')
				if (!jaxScript) return
				jaxScript.textContent = this._content
				enqueueUpdate(this)
			}
		
			connectedCallback() {
				this.textContent = this._content
				this._connected = true
				this.style.opacity = 1
				this.style.display = 'inline'
				enqueueTypeset(this)
			}
		})
	
		
		// https://ellie-test-19-cutover.now.sh/LFVgrr8Cf2a1
		
		var asciidoctor = Asciidoctor();
		
		customElements.define('asciidoc-text', class extends HTMLElement {
			constructor() {
				super()
				this._content = this.content
			}
		  
			get content() {
				return this._content
			}
		
			set content(value) {
				if (this._content === value) return
				this._content = value

				var jaxScript = this.querySelector('script')
				if (!jaxScript) return
				jaxScript.textContent = this._content
				enqueueUpdate(this)
			}
		
			connectedCallback() {
				this._connected = true
				this.style.opacity = 1
				this.style.display = 'inline'
				enqueueTypeset(this)

				this.innerHTML = asciidoctor.convert(this._content, {safe: 'safe', attributes: 'icons=font'})
			}
		})

		app.ports.infoForOutside.subscribe(msg => {

			console.log("app.ports.infoForOutside")

			switch(msg.tag) {

				case "DocumentData":
				if (msg.data != null) {
					localStorage.setItem("currentDocument", JSON.stringify(msg.data));
				}	
				break;

				case "DocumentListData":
				if (msg.data != null) {
					localStorage.setItem("currentDocumentList", JSON.stringify(msg.data));
				}
				break;

				case "AskToReconnectDocument":
				if (localStorage.currentDocument != null && localStorage.currentDocument[0] !='[') {
					app.ports.infoForElm.send({tag: "ReconnectDocument", data: JSON.parse(localStorage.currentDocument)})
				}
				break;

				case "AskToReconnectDocumentList":
				if (localStorage.currentDocumentList != null ) {
					app.ports.infoForElm.send({tag: "ReconnectDocumentList", data: JSON.parse(localStorage.currentDocumentList)})
				}
				break;

				case "UserData":
				if (msg.data != null) {
				localStorage.setItem("currentUser", JSON.stringify(msg.data));
				}
				break;

				case "AskToReconnectUser":
				if (localStorage.currentUser != null) {
					app.ports.infoForElm.send({tag: "ReconnectUser", data: JSON.parse(localStorage.currentUser)})
				}
				break;

				case "AskToEraseLocalStorage":
					localStorage.setItem("currentUser", null);	
					localStorage.setItem("currentDocument", null);
					localStorage.setItem("currentDocumentList", null);	
				break;

			}

		})

		var processDocumentData = function(documentData) {
		console.log("I will put the currentDocument data in local storage" );
		// console.log(JSON.stringify(documentData))
		localStorage.setItem("currentDocument", documentData);
		}
		
		var askToReconnectDocument = function (str) {
		console.log("!!! askToReconnectDocument !!!" );
		// app.ports.infoForElm.send({tag: "ReconnectDocument", data: localStorage})
		}

	
   
  </script>

 
</body>


	</body>
</html>
